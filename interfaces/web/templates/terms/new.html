{% extends "base.html" %}

{% block title %}Create Term - Ten Week Goal App{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/terms" style="color: #2196F3; text-decoration: none;">‚Üê Back to Terms</a>
</div>

<h2>Create New Term</h2>

<form id="termForm" style="max-width: 600px;">
    <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Term Number</label>
        <input type="number" id="term_number" value="{{ next_term_num }}" required
               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    </div>

    <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Theme (optional)</label>
        <input type="text" id="theme" placeholder="e.g., Foundation Building"
               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    </div>

    <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Start Date</label>
        <input type="date" id="start_date" value="{{ default_start }}" required
               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    </div>

    <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">End Date (or use duration calculator below)</label>
        <input type="date" id="end_date" value="{{ default_end }}"
               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    </div>

    <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 4px; background: #f9f9f9;">
        <h4 style="margin-top: 0;">Duration Calculator</h4>
        <p style="color: #666; font-size: 0.9em;">Calculate end date from duration</p>

        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <div style="flex: 1;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Duration</label>
                <input type="number" id="duration_value" value="10" min="1"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="flex: 1;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Unit</label>
                <select id="duration_unit" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="weeks" selected>Weeks</option>
                    <option value="days">Days</option>
                    <option value="months">Months</option>
                </select>
            </div>
        </div>

        <button type="button" onclick="calculateEndDate()"
                style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Calculate End Date
        </button>
    </div>

    {% if unassigned_goals %}
    <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Assign Goals (optional)</label>
        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
            {% for goal in unassigned_goals %}
            <label style="display: block; margin-bottom: 8px;">
                <input type="checkbox" name="goal_ids" value="{{ goal.id }}" style="margin-right: 8px;">
                {{ goal.description }}
            </label>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div style="margin-top: 30px;">
        <button type="submit" style="padding: 12px 24px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em;">
            Create Term
        </button>
        <a href="/terms" style="margin-left: 10px; padding: 12px 24px; background: #999; color: white; text-decoration: none; border-radius: 4px; display: inline-block;">
            Cancel
        </a>
    </div>

    <div id="message" style="margin-top: 20px;"></div>
</form>

<script>
function calculateEndDate() {
    const startDate = document.getElementById('start_date').value;
    const duration = parseInt(document.getElementById('duration_value').value);
    const unit = document.getElementById('duration_unit').value;

    if (!startDate || !duration) {
        alert('Please enter start date and duration');
        return;
    }

    const start = new Date(startDate);
    let end = new Date(start);

    switch(unit) {
        case 'days':
            end.setDate(start.getDate() + duration);
            break;
        case 'weeks':
            end.setDate(start.getDate() + (duration * 7));
            break;
        case 'months':
            end.setMonth(start.getMonth() + duration);
            break;
    }

    // Format as YYYY-MM-DD for date input
    const endStr = end.toISOString().split('T')[0];
    document.getElementById('end_date').value = endStr;
}

document.getElementById('termForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const termNumber = parseInt(document.getElementById('term_number').value);
    const theme = document.getElementById('theme').value;
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;

    // Get selected goal IDs
    const goalCheckboxes = document.querySelectorAll('input[name="goal_ids"]:checked');
    const goalIds = Array.from(goalCheckboxes).map(cb => parseInt(cb.value));

    const data = {
        term_number: termNumber,
        start_date: startDate,
        end_date: endDate,
        goal_ids: goalIds
    };

    if (theme) data.theme = theme;

    try {
        const response = await fetch('/api/terms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            window.location.href = '/terms/' + result.id;
        } else {
            document.getElementById('message').innerHTML =
                '<div style="padding: 10px; background: #f44336; color: white; border-radius: 4px;">' +
                'Error: ' + (result.error || 'Unknown error') + '</div>';
        }
    } catch (error) {
        document.getElementById('message').innerHTML =
            '<div style="padding: 10px; background: #f44336; color: white; border-radius: 4px;">' +
            'Error: ' + error.message + '</div>';
    }
});
</script>
{% endblock %}
