//
// ActionsListView.swift
// List view for displaying and managing actions
//
// Written by Claude Code on 2025-11-01
//
// PURPOSE:
// Main list view for actions with date-based grouping, add/edit/delete.
// Currently uses placeholder data - will connect to repository when persistence added.

import SwiftUI
import Models
import Services

/// Main list view for actions
///
/// Features:
/// - Actions grouped by date (Today, Yesterday, This Week, Earlier)
/// - Add new actions via sheet
/// - Edit existing actions via NavigationLink
/// - Swipe to delete
/// - Empty state when no actions
///
/// **Usage**:
/// ```swift
/// NavigationStack {
///     ActionsListView()
/// }
/// ```
public struct ActionsListView: View {

    // MARK: - State

    /// Placeholder actions (will be replaced with repository fetch)
    @State private var actions: [Action] = []

    /// Measurements by action ID (pre-formatted for display)
    /// In real implementation, this would be fetched from repository
    @State private var measurementsByAction: [UUID: [MeasurementDisplay]] = [:]

    /// Controls sheet presentation for new action form
    @State private var showingForm = false

    // MARK: - Body

    public var body: some View {
        NavigationStack {
            if actions.isEmpty {
                emptyStateView
            } else {
                actionsList
            }
        }
    }

    // MARK: - Views

    /// Empty state shown when no actions exist
    private var emptyStateView: some View {
        VStack(spacing: 20) {
            Image(systemName: "tray")
                .font(.system(size: 60))
                .foregroundStyle(.secondary)

            Text("No Actions Yet")
                .font(.title2)
                .fontWeight(.semibold)

            Text("Tap the + button to log your first action")
                .font(.body)
                .foregroundStyle(.secondary)
                .multilineTextAlignment(.center)
        }
        .padding()
        .navigationTitle("Actions")
        .toolbar {
            Button("Add", systemImage: "plus") {
                showingForm = true
            }
        }
        .sheet(isPresented: $showingForm) {
            ActionFormView(onValidate: handleNewAction)
        }
    }

    /// List of actions grouped by date
    private var actionsList: some View {
        List {
            ForEach(groupedActions) { group in
                Section(group.title) {
                    ForEach(group.items) { action in
                        NavigationLink {
                            // TODO: Edit mode for ActionFormView
                            ActionFormView(onValidate: { updatedData in
                                handleEditAction(action, with: updatedData)
                            })
                        } label: {
                            ActionRowView(
                                action: action,
                                measurements: measurementsByAction[action.id] ?? []
                            )
                        }
                        .swipeActions {
                            Button("Delete", role: .destructive) {
                                deleteAction(action)
                            }
                        }
                    }
                }
            }
        }
        .navigationTitle("Actions")
        .toolbar {
            Button("Add", systemImage: "plus") {
                showingForm = true
            }
        }
        .sheet(isPresented: $showingForm) {
            ActionFormView(onValidate: handleNewAction)
        }
    }

    // MARK: - Date Grouping

    /// Actions grouped by date categories using DateGrouping utility from Agent 2
    private var groupedActions: [DateGroup<Action>] {
        // Use logTime as the grouping key (startTime is optional)
        // When startTime exists, it's close enough to logTime for grouping purposes
        DateGrouping.groupByDate(actions, dateKeyPath: \.logTime)
    }

    // MARK: - Actions

    /// Handle new action from form
    private func handleNewAction(_ formData: ActionFormData) {
        print("‚úÖ Validated new action: \(formData.title)")
        print("   - Description: \(formData.detailedDescription)")
        print("   - Duration: \(formData.durationMinutes) minutes")
        print("   - Start time: \(formData.startTime)")
        print("   - Measurements: \(formData.measurements.count)")

        // Later: save via coordinator
        // let action = Action(...)
        // let measuredActions = formData.measurements.map { ... }
        // repository.save(action, with: measuredActions)
    }

    /// Handle edit action
    private func handleEditAction(_ action: Action, with formData: ActionFormData) {
        print("‚úÖ Validated edit for action: \(action.id)")
        print("   - New title: \(formData.title)")

        // Later: update via coordinator
        // repository.update(action.id, with: formData)
    }

    /// Delete an action
    private func deleteAction(_ action: Action) {
        print("üóëÔ∏è Deleting action: \(action.title ?? "Untitled")")
        actions.removeAll { $0.id == action.id }
        measurementsByAction.removeValue(forKey: action.id)

        // Later: delete via coordinator
        // repository.delete(action.id)
    }
}

// Note: DateGroup and DateGrouping utility are provided by Agent 2 in Templates/DateGrouping.swift

// MARK: - Previews

#Preview("Empty State") {
    ActionsListView()
}

#Preview("With Sample Data") {
    struct PreviewWrapper: View {
        @State var actions: [Action] = [
            Action(
                title: "Morning Run",
                detailedDescription: "5K in the park",
                durationMinutes: 28,
                startTime: Date()
            ),
            Action(
                title: "Team Meeting",
                detailedDescription: "Weekly sync",
                durationMinutes: 45,
                startTime: Date().addingTimeInterval(-3600)
            ),
            Action(
                title: "Guitar Practice",
                durationMinutes: 30,
                startTime: Date().addingTimeInterval(-86400)
            )
        ]

        var body: some View {
            // Note: In preview, we'd need to populate the actions state
            // For now, showing the basic structure
            ActionsListView()
                .onAppear {
                    // Would populate sample data here
                }
        }
    }

    return PreviewWrapper()
}
